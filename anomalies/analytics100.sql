-- ** Anomaly detection **
-- Compute an anomaly score for each record in the source stream using Random Cut Forest
-- Creates a temporary stream and defines a schema
CREATE OR REPLACE STREAM "TEMP_STREAM" (
   "column1"        DOUBLE,
   "column2"        DOUBLE,
   "column3"        DOUBLE,
   "column4"        DOUBLE,
   "column5"        DOUBLE,
   "column6"        DOUBLE,
   "column7"        DOUBLE,
   "column8"        DOUBLE,
   "column9"        DOUBLE,
   "column10"        DOUBLE,
   "column11"        DOUBLE,
   "column12"        DOUBLE,
   "column13"        DOUBLE,
   "column14"        DOUBLE,
   "column15"        DOUBLE,
   "column16"        DOUBLE,
   "column17"        DOUBLE,
   "column18"        DOUBLE,
   "column19"        DOUBLE,
   "column20"        DOUBLE,
   "column21"        DOUBLE,
   "column22"        DOUBLE,
   "column23"        DOUBLE,
   "column24"        DOUBLE,
   "column25"        DOUBLE,
   "column26"        DOUBLE,
   "column27"        DOUBLE,
   "column28"        DOUBLE,
   "column29"        DOUBLE,
   "column30"        DOUBLE,
   "column31"        DOUBLE,
   "column32"        DOUBLE,
   "column33"        DOUBLE,
   "column34"        DOUBLE,
   "column35"        DOUBLE,
   "column36"        DOUBLE,
   "column37"        DOUBLE,
   "column38"        DOUBLE,
   "column39"        DOUBLE,
   "column40"        DOUBLE,
   "column41"        DOUBLE,
   "column42"        DOUBLE,
   "column43"        DOUBLE,
   "column44"        DOUBLE,
   "column45"        DOUBLE,
   "column46"        DOUBLE,
   "column47"        DOUBLE,
   "column48"        DOUBLE,
   "column49"        DOUBLE,
   "column50"        DOUBLE,
   "column51"        DOUBLE,
   "column52"        DOUBLE,
   "column53"        DOUBLE,
   "column54"        DOUBLE,
   "column55"        DOUBLE,
   "column56"        DOUBLE,
   "column57"        DOUBLE,
   "column58"        DOUBLE,
   "column59"        DOUBLE,
   "column60"        DOUBLE,
   "column61"        DOUBLE,
   "column62"        DOUBLE,
   "column63"        DOUBLE,
   "column64"        DOUBLE,
   "column65"        DOUBLE,
   "column66"        DOUBLE,
   "column67"        DOUBLE,
   "column68"        DOUBLE,
   "column69"        DOUBLE,
   "column70"        DOUBLE,
   "column71"        DOUBLE,
   "column72"        DOUBLE,
   "column73"        DOUBLE,
   "column74"        DOUBLE,
   "column75"        DOUBLE,
   "column76"        DOUBLE,
   "column77"        DOUBLE,
   "column78"        DOUBLE,
   "column79"        DOUBLE,
   "column80"        DOUBLE,
   "column81"        DOUBLE,
   "column82"        DOUBLE,
   "column83"        DOUBLE,
   "column84"        DOUBLE,
   "column85"        DOUBLE,
   "column86"        DOUBLE,
   "column87"        DOUBLE,
   "column88"        DOUBLE,
   "column89"        DOUBLE,
   "column90"        DOUBLE,
   "column91"        DOUBLE,
   "column92"        DOUBLE,
   "column93"        DOUBLE,
   "column94"        DOUBLE,
   "column95"        DOUBLE,
   "column96"        DOUBLE,
   "column97"        DOUBLE,
   "column98"        DOUBLE,
   "column99"        DOUBLE,
   "column100"        DOUBLE,
   "ANOMALY_SCORE"  DOUBLE);
-- Creates an output stream and defines a schema
CREATE OR REPLACE STREAM "DESTINATION_SQL_STREAM" (
   "column1"        DOUBLE,
   "column2"        DOUBLE,
   "column3"        DOUBLE,
   "column4"        DOUBLE,
   "column5"        DOUBLE,
   "column6"        DOUBLE,
   "column7"        DOUBLE,
   "column8"        DOUBLE,
   "column9"        DOUBLE,
   "column10"        DOUBLE,
   "column11"        DOUBLE,
   "column12"        DOUBLE,
   "column13"        DOUBLE,
   "column14"        DOUBLE,
   "column15"        DOUBLE,
   "column16"        DOUBLE,
   "column17"        DOUBLE,
   "column18"        DOUBLE,
   "column19"        DOUBLE,
   "column20"        DOUBLE,
   "column21"        DOUBLE,
   "column22"        DOUBLE,
   "column23"        DOUBLE,
   "column24"        DOUBLE,
   "column25"        DOUBLE,
   "column26"        DOUBLE,
   "column27"        DOUBLE,
   "column28"        DOUBLE,
   "column29"        DOUBLE,
   "column30"        DOUBLE,
   "column31"        DOUBLE,
   "column32"        DOUBLE,
   "column33"        DOUBLE,
   "column34"        DOUBLE,
   "column35"        DOUBLE,
   "column36"        DOUBLE,
   "column37"        DOUBLE,
   "column38"        DOUBLE,
   "column39"        DOUBLE,
   "column40"        DOUBLE,
   "column41"        DOUBLE,
   "column42"        DOUBLE,
   "column43"        DOUBLE,
   "column44"        DOUBLE,
   "column45"        DOUBLE,
   "column46"        DOUBLE,
   "column47"        DOUBLE,
   "column48"        DOUBLE,
   "column49"        DOUBLE,
   "column50"        DOUBLE,
   "column51"        DOUBLE,
   "column52"        DOUBLE,
   "column53"        DOUBLE,
   "column54"        DOUBLE,
   "column55"        DOUBLE,
   "column56"        DOUBLE,
   "column57"        DOUBLE,
   "column58"        DOUBLE,
   "column59"        DOUBLE,
   "column60"        DOUBLE,
   "column61"        DOUBLE,
   "column62"        DOUBLE,
   "column63"        DOUBLE,
   "column64"        DOUBLE,
   "column65"        DOUBLE,
   "column66"        DOUBLE,
   "column67"        DOUBLE,
   "column68"        DOUBLE,
   "column69"        DOUBLE,
   "column70"        DOUBLE,
   "column71"        DOUBLE,
   "column72"        DOUBLE,
   "column73"        DOUBLE,
   "column74"        DOUBLE,
   "column75"        DOUBLE,
   "column76"        DOUBLE,
   "column77"        DOUBLE,
   "column78"        DOUBLE,
   "column79"        DOUBLE,
   "column80"        DOUBLE,
   "column81"        DOUBLE,
   "column82"        DOUBLE,
   "column83"        DOUBLE,
   "column84"        DOUBLE,
   "column85"        DOUBLE,
   "column86"        DOUBLE,
   "column87"        DOUBLE,
   "column88"        DOUBLE,
   "column89"        DOUBLE,
   "column90"        DOUBLE,
   "column91"        DOUBLE,
   "column92"        DOUBLE,
   "column93"        DOUBLE,
   "column94"        DOUBLE,
   "column95"        DOUBLE,
   "column96"        DOUBLE,
   "column97"        DOUBLE,
   "column98"        DOUBLE,
   "column99"        DOUBLE,
   "column100"        DOUBLE,
   "ANOMALY_SCORE"  DOUBLE);
 
-- Compute an anomaly score for each record in the source stream
-- using Random Cut Forest
CREATE OR REPLACE PUMP "STREAM_PUMP" AS INSERT INTO "TEMP_STREAM"
SELECT STREAM "COL0","COL1", "COL2", "COL3", "COL4", "COL5", "COL6", "COL7", "COL8", "COL9", "COL10", "COL11", "COL12", "COL13", "COL14", "COL15", "COL16", "COL17", "COL18", "COL19", "COL20", "COL21", "COL22", "COL23", "COL24", "COL25", "COL26", "COL27", "COL28", "COL29", "COL30", "COL31", "COL32", "COL33", "COL34", "COL35", "COL36", "COL37", "COL38", "COL39", "COL40", "COL41", "COL42", "COL43", "COL44", "COL45", "COL46", "COL47", "COL48", "COL49", "COL50", "COL51", "COL52", "COL53", "COL54", "COL55", "COL56", "COL57", "COL58", "COL59", "COL60", "COL61", "COL62", "COL63", "COL64", "COL65", "COL66", "COL67", "COL68", "COL69", "COL70", "COL71", "COL72", "COL73", "COL74", "COL75", "COL76", "COL77", "COL78", "COL79", "COL80", "COL81", "COL82", "COL83", "COL84", "COL85", "COL86", "COL87", "COL88", "COL89", "COL90", "COL91", "COL92", "COL93", "COL94", "COL95", "COL96", "COL97", "COL98", "COL99", "ANOMALY_SCORE" FROM
  TABLE(RANDOM_CUT_FOREST(
    CURSOR(SELECT STREAM * FROM "SOURCE_SQL_STREAM_001")
  )
);
-- Sort records by descending anomaly score, insert into output stream
CREATE OR REPLACE PUMP "OUTPUT_PUMP" AS INSERT INTO "DESTINATION_SQL_STREAM"
SELECT STREAM * FROM "TEMP_STREAM" 
ORDER BY FLOOR("TEMP_STREAM".ROWTIME TO SECOND), ANOMALY_SCORE DESC;

